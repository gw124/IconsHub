name: CI Deploy to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      custom_domain:
        description: 'è‡ªå®šä¹‰åŸŸå (å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„åŸŸå)'
        required: false
        type: string
      custom_branch:
        description: 'éƒ¨ç½²åˆ†æ”¯ (å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„åˆ†æ”¯)'
        required: false
        type: string
        default: 'Web'
      custom_commit_message:
        description: 'æäº¤ä¿¡æ¯ (å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„ä¿¡æ¯)'
        required: false
        type: string
  push:
    branches:
      - main
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Load configuration
        id: config
        run: |
          echo "Loading configuration from config.yml..."
          if [ -f config.yml ]; then
            echo "Configuration file found"
            # ä½¿ç”¨ Node.js è¯»å–é…ç½®
            node -e "
              const fs = require('fs');
              const yaml = require('js-yaml');
              const config = yaml.load(fs.readFileSync('config.yml', 'utf8'));
              const domain = config.deployment.domain;
              const branch = config.deployment.branch;
              console.log('domain=' + domain);
              console.log('cname=' + domain);
              console.log('branch=' + branch);
              console.log('commit_message=ğŸš€ Auto deploy: Update icons and rebuild');
            " >> $GITHUB_OUTPUT
          else
            echo "âŒ config.yml not found! Please create the configuration file."
            exit 1
          fi

      - name: Set deployment parameters
        id: deploy_params
        run: |
          # ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥æˆ–é…ç½®æ–‡ä»¶çš„å€¼
          DOMAIN="${{ github.event.inputs.custom_domain || steps.config.outputs.domain }}"
          CNAME="${{ github.event.inputs.custom_domain || steps.config.outputs.cname }}"
          BRANCH="${{ github.event.inputs.custom_branch || steps.config.outputs.branch }}"
          COMMIT_MSG="${{ github.event.inputs.custom_commit_message || steps.config.outputs.commit_message }}"
          
          echo "Final deployment parameters:"
          echo "Domain: $DOMAIN"
          echo "CNAME: $CNAME"
          echo "Branch: $BRANCH"
          echo "Commit Message: $COMMIT_MSG"
          
          echo "deploy_domain=$DOMAIN" >> $GITHUB_OUTPUT
          echo "deploy_cname=$CNAME" >> $GITHUB_OUTPUT
          echo "deploy_branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "deploy_commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT

      - name: Scan icons and auto-update db.json
        run: |
          echo "ğŸ” æ‰«æå›¾æ ‡å¹¶æ›´æ–° db.json..."
          npm run scan-icons
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ”¹åŠ¨
          if ! git diff --quiet public/db.json public/category-titles.json public/config.yml; then
            echo "ğŸ“ æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨æäº¤æ›´æ–°"
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add public/db.json public/category-titles.json public/config.yml
            git commit -m "chore: è‡ªåŠ¨æ›´æ–° db.json å’Œé…ç½®æ–‡ä»¶ [skip ci]"
            git push
            echo "âœ… db.json å·²è‡ªåŠ¨æ›´æ–°å¹¶æäº¤"
          else
            echo "âœ… é…ç½®æ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          fi

      - name: Build project
        run: npm run build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: ${{ steps.deploy_params.outputs.deploy_branch }}
          commit_message: ${{ steps.deploy_params.outputs.deploy_commit_message }}
          cname: ${{ steps.deploy_params.outputs.deploy_cname }}
